<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Bonds Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
            width: 95%;
            max-width: 700px;
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #10b981;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #059669;
        }
        .input-field {
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1.5rem;
            text-align: center;
            font-weight: 700;
            transition: border-color 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
        }
        .input-field:disabled {
            background-color: #f3f4f6;
        }
        .question-text {
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            font-weight: 700;
            color: #1f2937;
            letter-spacing: 2px;
        }
        .feedback {
            height: 2rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .feedback-correct { color: #10b981; }
        .feedback-incorrect { color: #ef4444; }
        
        /* Grid styling */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        .level-btn {
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
        }
        .level-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .level-number {
            font-size: 1.75rem;
        }
        .best-time {
            font-size: 0.75rem;
            font-weight: 500;
        }
        /* Tile Colors based on Rating */
        .rating-none { background-color: #f3f4f6; color: #374151; }
        .rating-apprentice { background-color: #dcfce7; color: #166534; border-color: #86efac; }
        .rating-pro { background-color: #a7f3d0; color: #047857; border-color: #6ee7b7; }
        .rating-expert { background-color: #6ee7b7; color: #065f46; border-color: #34d399; }
        .rating-mastery { background: linear-gradient(145deg, #fde047, #facc15); color: #a16207; border-color: #f59e0b; }
        
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <canvas id="confetti-canvas"></canvas>

    <div class="container mx-auto text-center">

        <!-- Settings Screen -->
        <div id="settings-screen" class="card mx-auto">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Number Bonds Challenge</h1>
            <p class="text-gray-600 mb-8">Select a level. Get 10 in a row to set your best time!</p>
            <div id="level-grid" class="level-grid"></div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="card mx-auto hidden">
            <div class="flex justify-between items-center mb-6 text-lg">
                <div class="font-semibold text-gray-700">Streak: <span id="streak-counter" class="font-bold text-indigo-600 text-xl">0</span>/10</div>
                <div class="font-semibold text-gray-700">Time: <span id="timer" class="font-bold text-indigo-600 text-xl">00:00</span></div>
            </div>
            <div id="question-container" class="my-8 min-h-[60px] flex items-center justify-center">
                <p id="question-text" class="question-text"></p>
            </div>
            <div class="mb-4">
                <input type="number" id="answer-input" class="input-field" placeholder="?">
            </div>
             <div id="feedback-message" class="feedback mb-4 text-lg"></div>
            <button id="check-btn" class="btn btn-primary w-full max-w-xs mx-auto text-lg">Check Answer</button>
             <button id="quit-btn" class="mt-4 text-gray-500 hover:text-gray-700 font-semibold">Back to Levels</button>
        </div>

        <!-- Success Screen -->
        <div id="success-screen" class="card mx-auto hidden">
            <h2 class="text-3xl md:text-4xl font-bold text-green-500 mb-4">üéâ Challenge Complete! üéâ</h2>
            <p class="text-gray-700 text-xl mb-2">You got 10 in a row for bonds to <span id="completed-level" class="font-bold"></span>!</p>
            <p class="text-gray-700 text-xl mb-4">Your time: <span id="final-time" class="font-bold text-indigo-600"></span></p>
            <div id="rating-info" class="bg-indigo-100 text-indigo-800 rounded-xl p-4 mb-6">
                <p class="text-lg font-semibold">Rating: <span id="final-rating" class="font-bold"></span></p>
                <p id="best-time-message" class="mt-1 font-medium"></p>
                <p id="rating-explanation" class="text-sm mt-2 text-indigo-700"></p>
            </div>
            <button id="play-again-btn" class="btn btn-secondary w-full max-w-xs mx-auto text-lg">Back to Levels</button>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const settingsScreen = document.getElementById('settings-screen'), gameScreen = document.getElementById('game-screen'), successScreen = document.getElementById('success-screen');
        const levelGrid = document.getElementById('level-grid'), checkBtn = document.getElementById('check-btn'), playAgainBtn = document.getElementById('play-again-btn'), quitBtn = document.getElementById('quit-btn');
        const streakCounter = document.getElementById('streak-counter'), timerDisplay = document.getElementById('timer'), questionText = document.getElementById('question-text'), answerInput = document.getElementById('answer-input');
        const feedbackMessage = document.getElementById('feedback-message'), finalTimeDisplay = document.getElementById('final-time'), completedLevelDisplay = document.getElementById('completed-level');
        const finalRatingDisplay = document.getElementById('final-rating'), bestTimeMessage = document.getElementById('best-time-message'), ratingExplanation = document.getElementById('rating-explanation');
        const canvas = document.getElementById('confetti-canvas'), ctx = canvas.getContext('2d');

        // --- Game State & Config ---
        const LEVELS = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 30, 40, 50, 60, 70, 80, 90, 100, 180, 360];
        const POSITIVE_FEEDBACK = ["Awesome!", "Great Job!", "You got it!", "Fantastic!", "Brilliant!", "Keep it up!"];
        let targetNumber = 10, currentAnswer = 0, correctStreak = 0, timerInterval, secondsElapsed = 0, confettiParticles = [];

        // --- Initialization ---
        function initialize() {
            renderLevelGrid();
            checkBtn.addEventListener('click', checkAnswer);
            playAgainBtn.addEventListener('click', resetGame);
            quitBtn.addEventListener('click', resetGame);
            answerInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkAnswer(); });
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        }

        // --- Screen & UI Management ---
        function renderLevelGrid() {
            levelGrid.innerHTML = '';
            LEVELS.forEach(level => {
                const bestTime = getBestTime(level);
                const rating = bestTime ? getRating(bestTime).key : 'none';
                const button = document.createElement('button');
                button.className = `level-btn rating-${rating}`;
                button.dataset.level = level;
                button.innerHTML = `
                    <span class="level-number">${level}</span>
                    <span class="best-time">${bestTime ? `üèÜ ${formatTime(bestTime)}` : 'No time yet'}</span>
                `;
                button.addEventListener('click', () => startGame(level));
                levelGrid.appendChild(button);
            });
        }

        function showScreen(screen) {
            [settingsScreen, gameScreen, successScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        // --- Game Flow ---
        function startGame(level) {
            targetNumber = level;
            correctStreak = 0;
            secondsElapsed = 0;
            updateStreakDisplay();
            timerDisplay.textContent = formatTime(0);
            showScreen(gameScreen);
            startTimer();
            generateQuestion();
        }

        function resetGame() {
            clearInterval(timerInterval);
            renderLevelGrid();
            showScreen(settingsScreen);
            feedbackMessage.textContent = '';
        }

        function showSuccess() {
            clearInterval(timerInterval);
            const previousBest = getBestTime(targetNumber);
            let isNewBest = false;
            const currentRating = getRating(secondsElapsed);

            if (!previousBest || secondsElapsed < previousBest) {
                saveBestTime(targetNumber, secondsElapsed);
                isNewBest = true;
            }

            completedLevelDisplay.textContent = targetNumber;
            finalTimeDisplay.textContent = formatTime(secondsElapsed);
            finalRatingDisplay.textContent = currentRating.name;
            ratingExplanation.textContent = `Ratings are based on average time per question. Mastery is under 2 seconds!`;
            
            if (isNewBest) {
                bestTimeMessage.textContent = "üèÜ New best time!";
                triggerConfetti(150);
            } else {
                bestTimeMessage.textContent = `Your best is ${formatTime(previousBest)}. Keep trying!`;
            }
            showScreen(successScreen);
        }

        // --- Question & Answer Logic ---
        function generateQuestion() {
            answerInput.value = '';
            answerInput.disabled = false;
            checkBtn.disabled = false;
            answerInput.focus();
            feedbackMessage.textContent = '';
            feedbackMessage.className = 'feedback mb-4 text-lg';

            const num1 = Math.floor(Math.random() * (targetNumber + 1));
            const num2 = targetNumber - num1;
            const questionTypes = [
                { format: `${num1} + <span class="text-indigo-600">___</span> = ${targetNumber}`, answer: num2 },
                { format: `<span class="text-indigo-600">___</span> + ${num2} = ${targetNumber}`, answer: num1 },
                { format: `${targetNumber} - ${num1} = <span class="text-indigo-600">___</span>`, answer: num2 },
                { format: `${targetNumber} - <span class="text-indigo-600">___</span> = ${num2}`, answer: num1 }
            ];
            
            const selectedQuestion = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            questionText.innerHTML = selectedQuestion.format;
            currentAnswer = selectedQuestion.answer;
        }
        
        function checkAnswer() {
            if (checkBtn.disabled) return; // Prevents multiple submissions
            const userAnswer = parseInt(answerInput.value);
            if (isNaN(userAnswer)) return;

            if (userAnswer === currentAnswer) handleCorrectAnswer();
            else handleIncorrectAnswer();
        }

        function handleCorrectAnswer() {
            // BUG FIX: Disable inputs immediately to prevent multiple submissions
            checkBtn.disabled = true;
            answerInput.disabled = true;

            correctStreak++;
            updateStreakDisplay();
            const randomFeedback = POSITIVE_FEEDBACK[Math.floor(Math.random() * POSITIVE_FEEDBACK.length)];
            feedbackMessage.textContent = randomFeedback;
            feedbackMessage.className = 'feedback mb-4 text-lg feedback-correct';
            triggerConfetti(40); // Small burst

            // Set timeout to requested 300ms
            if (correctStreak >= 10) {
                setTimeout(showSuccess, 300);
            } else {
                setTimeout(generateQuestion, 300);
            }
        }

        function handleIncorrectAnswer() {
            correctStreak = 0;
            updateStreakDisplay();
            feedbackMessage.textContent = `Not quite. The answer was ${currentAnswer}.`;
            feedbackMessage.className = 'feedback mb-4 text-lg feedback-incorrect';
            
            clearInterval(timerInterval);
            secondsElapsed = 0;
            timerDisplay.textContent = formatTime(0);
            startTimer();

            setTimeout(generateQuestion, 1000);
        }

        // --- Helpers & Data Persistence ---
        function updateStreakDisplay() { streakCounter.textContent = correctStreak; }
        function startTimer() { timerInterval = setInterval(() => { secondsElapsed++; timerDisplay.textContent = formatTime(secondsElapsed); }, 1000); }
        function formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function getBestTime(level) { return localStorage.getItem(`nb_bestTime_${level}`); }
        function saveBestTime(level, time) { localStorage.setItem(`nb_bestTime_${level}`, time); }

        function getRating(time) {
            const avg = time / 10;
            if (avg < 2) return { name: "‚ö°Ô∏è Mastery ‚ö°Ô∏è", key: "mastery" };
            if (avg < 4) return { name: "Expert", key: "expert" };
            if (avg < 7) return { name: "Pro", key: "pro" };
            return { name: "Apprentice", key: "apprentice" };
        }

        // --- Confetti Effect ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function triggerConfetti(count) {
            for (let i = 0; i < count; i++) {
                confettiParticles.push(new ConfettiParticle());
            }
        }
        
        class ConfettiParticle {
            constructor() {
                this.x = canvas.width / 2;
                this.y = canvas.height / 2;
                this.radius = Math.random() * 3 + 2;
                this.color = `hsl(${Math.random() * 360}, 100%, 70%)`;
                this.velocity = {
                    x: (Math.random() - 0.5) * 15,
                    y: (Math.random() - 0.5) * 15
                };
                this.alpha = 1;
                this.friction = 0.98;
                this.gravity = 0.1;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
            }

            update() {
                this.velocity.x *= this.friction;
                this.velocity.y *= this.friction;
                this.velocity.y += this.gravity;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.alpha -= 0.01;
                this.draw();
            }
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            confettiParticles = confettiParticles.filter(p => p.alpha > 0);
            confettiParticles.forEach(p => p.update());
            requestAnimationFrame(animateConfetti);
        }


        // --- Start the app ---
        initialize();
        animateConfetti();
    </script>
</body>
</html>
